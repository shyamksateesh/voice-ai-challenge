<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LyrAssist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic scrollbar styling for the log box */
        #log-box::-webkit-scrollbar {
            width: 8px;
        }
        #log-box::-webkit-scrollbar-track {
            background: #1a202c; /* gray-900 */
        }
        #log-box::-webkit-scrollbar-thumb {
            background-color: #4a5568; /* gray-600 */
            border-radius: 4px;
            border: 2px solid #1a202c; /* gray-900 */
        }
        /* Spinner styles */
        .lds-dual-ring {
            display: inline-block; /* Changed to inline-block */
            width: 20px;
            height: 20px;
            margin-right: 8px; /* Space between spinner and text */
            vertical-align: middle; /* Align spinner vertically */
        }
        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 16px;
            height: 16px;
            margin: 2px;
            border-radius: 50%;
            border: 3px solid #cbd5e0; /* gray-300 */
            border-color: #cbd5e0 transparent #cbd5e0 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }
        @keyframes lds-dual-ring {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* Dark theme adjustments */
        body { background-color: #1a202c; color: #e2e8f0; }
        .bg-gray-800 { background-color: #2d3748; }
        .text-gray-400 { color: #a0aec0; }
        .text-gray-500 { color: #718096; }
        .border-gray-600 { border-color: #4a5568; }
        .border-gray-700 { border-color: #2d3748; }
        .bg-gray-700 { background-color: #4a5568; }
        .bg-gray-900 { background-color: #1a202c; }
        .text-white { color: #f7fafc; }
        .bg-indigo-600 { background-color: #5a67d8; }
        .hover\:bg-indigo-700:hover { background-color: #4c51bf; }
        .bg-green-600 { background-color: #38a169; }
        .hover\:bg-green-700:hover { background-color: #2f855a; }
        .bg-red-600 { background-color: #e53e3e; }
        .hover\:bg-red-700:hover { background-color: #c53030; }
        .bg-gray-600 { background-color: #718096; }
        .hover\:bg-gray-700:hover { background-color: #4a5568; }
        .text-indigo-400 { color: #7f9cf5; }
        .hover\:text-indigo-300:hover { color: #a3bffa; }
        .bg-red-900 { background-color: #742a2a; }
        .border-red-700 { border-color: #c53030; }
        .text-red-200 { color: #fed7d7; }
        .text-red-400 { color: #fc8181; }

    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen font-sans">
    <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-2xl">

        <!-- Initial Form View -->
        <div id="upload-form">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">LyrAssist</h1>
                <h2 class="text-lg text-gray-400">AI-Powered Lyric Transcription & Video Generation</h2>
                <p class="text-xs text-gray-500 mt-1">(Hiya Innovation Challenge Prototype)</p>
            </div>

            <form id="process-form" enctype="multipart/form-data">
                <!-- File Upload -->
                <div class="mb-6">
                    <label for="file" class="block text-sm font-medium text-gray-300 mb-2">Upload Video/Audio File:</label>
                    <input type="file" id="file" name="file" accept="video/*,audio/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer">
                </div>
                <!-- OR Separator -->
                <div class="mb-6 text-center text-gray-400">OR</div>
                <!-- Audio Recording -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Record Audio:</label>
                    <div class="flex items-center space-x-4">
                        <button type="button" id="startRecord" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">Start Recording</button>
                        <button type="button" id="stopRecord" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out" disabled>Stop Recording</button>
                        <span id="recordingStatus" class="text-sm text-gray-400"></span>
                    </div>
                    <audio id="audioPlayback" controls class="mt-4 w-full hidden"></audio>
                </div>
                <!-- Divider -->
                <hr class="border-gray-600 my-6">
                <!-- Whisper Model Selection -->
                <div class="mb-4">
                    <label for="model" class="block text-sm font-medium text-gray-300 mb-2">Whisper Model:</label>
                    <select id="model" name="model" class="block w-full bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <option value="tiny.en">Tiny</option>
                        <option value="base.en">Base</option>
                        <option value="small.en">Small</option>
                        <option value="medium.en" selected>Medium</option>
                        <option value="large.en">Large</option>
                    </select>
                </div>
                <!-- Processing Options -->
                <div class="mb-6 space-y-3">
                     <label class="flex items-center text-sm text-gray-300">
                        <input type="checkbox" id="separate-vocals" name="separate_vocals" class="form-checkbox h-4 w-4 text-indigo-600 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500">
                        <span class="ml-2">Separate Vocals (Slow)</span>
                    </label>
                   <label class="flex items-center text-sm text-gray-300">
                        <input type="checkbox" id="wipe-text" name="wipe_text" class="form-checkbox h-4 w-4 text-indigo-600 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500">
                        <span class="ml-2">Karaoke Wipe Text (Slow)</span>
                    </label>
                </div>
                <!-- Submit Button -->
                <div class="mt-6">
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out flex items-center justify-center">
                        <span id="submit-text">Start Processing</span>
                        <div id="submit-spinner" class="lds-dual-ring hidden ml-2" style="width: 16px; height: 16px; border-width: 2px;"></div>
                    </button>
                </div>
            </form>
        </div>

        <!-- Status/Result View -->
        <div id="status-view" class="hidden text-center">
            <h1 id="status-title" class="text-2xl font-semibold mb-4 text-white">Processing Status</h1>
            <!-- <<< FIX: Add spinner span here >>> -->
            <p id="status-message" class="text-lg text-gray-300 mb-6 flex items-center justify-center">
                <span id="status-spinner" class="lds-dual-ring hidden"></span> <!-- Initially hidden -->
                <span id="status-text">Uploading file...</span>
            </p>

            <!-- Live Log Box -->
            <div class="mb-6 text-left">
                <label class="block text-sm font-medium text-gray-300 mb-2">Live Log:</label>
                <pre id="log-box" class="h-40 bg-gray-900 text-gray-300 text-xs font-mono p-3 rounded overflow-y-auto border border-gray-700 whitespace-pre-wrap break-words">Waiting for logs...</pre>
            </div>

             <!-- Song Info Box Removed -->

            <!-- Result Area -->
            <div id="result-area" class="hidden mt-6 text-left">
                 <h3 class="text-lg font-semibold text-white mb-3">Result</h3>
                 <div id="video-container" class="mb-4 aspect-video bg-black rounded overflow-hidden">
                    <!-- Video will be embedded here -->
                 </div>
                 <div class="flex space-x-4">
                     <a id="download-link" href="#" download class="flex-1 text-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">Download Video</a>
                     <button id="process-another" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">Process Another File</button>
                 </div>
            </div>

            <!-- Error Message Area -->
             <div id="error-message-box" class="hidden mt-6 text-left p-4 bg-red-900 border border-red-700 rounded">
                <p id="error-message-content" class="text-red-200 text-sm"></p>
             </div>
             <button id="try-again-button" class="hidden mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">Try Again</button>

        </div>

    </div>

    <script>
        const form = document.getElementById('process-form');
        const uploadFormDiv = document.getElementById('upload-form');
        const statusViewDiv = document.getElementById('status-view');
        const statusTitle = document.getElementById('status-title');
        const statusMessageP = document.getElementById('status-message'); // <<< Get paragraph
        const statusSpinner = document.getElementById('status-spinner'); // <<< Get spinner span
        const statusText = document.getElementById('status-text'); // <<< Get text span
        const logBox = document.getElementById('log-box');
        const resultArea = document.getElementById('result-area');
        const videoContainer = document.getElementById('video-container');
        const downloadLink = document.getElementById('download-link');
        const processAnotherButton = document.getElementById('process-another');
        const errorMessageBox = document.getElementById('error-message-box');
        const errorMessageContent = document.getElementById('error-message-content');
        const tryAgainButton = document.getElementById('try-again-button');
        const submitButton = form.querySelector('button[type="submit"]');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');
        // Song Info elements removed

        // --- Audio Recording Logic (remains the same) ---
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        const startRecordButton = document.getElementById('startRecord');
        const stopRecordButton = document.getElementById('stopRecord');
        const recordingStatus = document.getElementById('recordingStatus');
        const audioPlayback = document.getElementById('audioPlayback');
        const fileInput = document.getElementById('file');

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            startRecordButton.addEventListener('click', async () => { /* ... */ });
            stopRecordButton.addEventListener('click', () => { /* ... */ });
        } else { /* ... disable recording ... */ }
        // --- End Audio Recording ---


        // --- Form Submission ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitButton.disabled = true; submitText.textContent = 'Processing...'; submitSpinner.classList.remove('hidden');

            const formData = new FormData();
            const fileField = document.getElementById('file');
            if (audioBlob) { formData.append('audio_blob', audioBlob, 'audio_recording.wav'); logBox.textContent = "Uploading recorded audio...\n"; }
            else if (fileField.files.length > 0) { formData.append('file', fileField.files[0]); logBox.textContent = `Uploading ${fileField.files[0].name}...\n`; }
            else { showError("Please select a file or record audio."); submitButton.disabled = false; submitText.textContent = 'Start Processing'; submitSpinner.classList.add('hidden'); return; }

            formData.append('model', document.getElementById('model').value);
            formData.append('separate_vocals', document.getElementById('separate-vocals').checked);
            formData.append('wipe_text', document.getElementById('wipe-text').checked);

            uploadFormDiv.classList.add('hidden'); statusViewDiv.classList.remove('hidden');
            statusText.textContent = 'Uploading file...'; // <<< Set text part
            statusSpinner.classList.remove('hidden'); // <<< Show spinner
            errorMessageBox.classList.add('hidden'); tryAgainButton.classList.add('hidden');
            // songInfoBox removed

            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || `HTTP error! status: ${response.status}`); }
                const data = await response.json();
                statusText.textContent = 'Processing started. Waiting for updates...'; // <<< Set text part
                statusSpinner.classList.remove('hidden'); // <<< Keep spinner visible
                logBox.textContent += "Upload complete. Starting backend processing...\n";
                pollStatus(data.task_id);
            } catch (error) {
                console.error('Upload failed:', error); showError(`Upload failed: ${error.message}`);
                submitButton.disabled = false; submitText.textContent = 'Start Processing'; submitSpinner.classList.add('hidden');
                statusSpinner.classList.add('hidden'); // <<< Hide spinner on failure
            }
        });

        let pollInterval;
        let currentLogLength = 0;
        function pollStatus(taskId) {
            pollInterval = setInterval(async () => {
                console.log(`Polling status for task: ${taskId}`);
                try {
                    const response = await fetch(`/status/${taskId}`);
                    console.log(`Polling response status: ${response.status}`);
                    if (!response.ok) { console.error(`Polling error: ${response.status}`); updateLogBox(["Polling error."]); return; }
                    const data = await response.json();
                    console.log("Polling response data:", data);

                    updateLogBox(data.log || []);
                    // Song Info logic removed

                    if (data.status === 'complete') {
                        console.log("Processing complete."); clearInterval(pollInterval);
                        statusText.textContent = 'Processing Complete!'; // <<< Set text part
                        statusSpinner.classList.add('hidden'); // <<< Hide spinner
                        statusTitle.textContent = 'Processing Complete!';

                        if (!data.output_filename) { console.error("Filename missing."); showError("Output filename missing."); return; }
                        console.log(`Output filename: ${data.output_filename}`);

                        resultArea.classList.remove('hidden');
                        const videoUrl = `/serve_video/${encodeURIComponent(data.output_filename)}`;
                        console.log(`Video URL: ${videoUrl}`);

                        if (!videoContainer) { console.error("videoContainer missing!"); showError("UI error: Container missing."); }
                        else {
                            videoContainer.innerHTML = `<video controls preload="metadata" class="w-full h-full rounded" src="${videoUrl}"></video>`;
                            console.log("Video HTML set.");
                            const videoElement = videoContainer.querySelector('video');
                            if (videoElement) {
                                videoElement.addEventListener('error', (e) => { /* ... error handling ... */ });
                                videoElement.addEventListener('loadedmetadata', () => { console.log('Metadata loaded.'); });
                                videoElement.addEventListener('canplay', () => { console.log('Video can play.'); });
                            } else { console.error("Video element not found!"); showError("UI error: Player creation failed."); }
                        }
                        downloadLink.href = videoUrl; downloadLink.download = data.output_filename;
                        console.log(`Download link: ${downloadLink.href}`);
                        submitButton.disabled = false; submitText.textContent = 'Start Processing'; submitSpinner.classList.add('hidden');

                    } else if (data.status === 'failed') {
                        console.log("Processing failed."); clearInterval(pollInterval);
                        statusText.textContent = 'Processing Failed!'; // <<< Set text part
                        statusSpinner.classList.add('hidden'); // <<< Hide spinner
                        statusTitle.textContent = 'Processing Failed!';
                        showError(data.error || 'Unknown backend error.');
                        submitButton.disabled = false; submitText.textContent = 'Start Processing'; submitSpinner.classList.add('hidden');
                    } else {
                        // Still processing
                        statusText.textContent = 'Processing... See log below.'; // <<< Set text part
                        statusSpinner.classList.remove('hidden'); // <<< Keep spinner visible
                        statusTitle.textContent = 'Processing Status';
                    }
                } catch (error) { console.error('Polling failed:', error); updateLogBox([`Polling failed: ${error.message}. Retrying...`]); }
            }, 3000);
        }

        // Song Info display function removed

        function updateLogBox(logs) { /* ... remains the same, using <pre> now ... */
            if (!Array.isArray(logs)) return;
            if (logBox.textContent.trim() === 'Waiting for logs...' && logs.length > 0) {
                 logBox.textContent = '';
                 currentLogLength = 0;
            }
            if (logs.length > currentLogLength) {
                const newLogs = logs.slice(currentLogLength);
                logBox.textContent += newLogs.join('\n') + '\n';
                logBox.scrollTop = logBox.scrollHeight;
                currentLogLength = logs.length;
            }
         }


        function resetUI() {
            clearInterval(pollInterval);
            uploadFormDiv.classList.remove('hidden'); statusViewDiv.classList.add('hidden');
            resultArea.classList.add('hidden'); errorMessageBox.classList.add('hidden');
            tryAgainButton.classList.add('hidden'); // songInfoBox removed
            videoContainer.innerHTML = ''; logBox.textContent = 'Waiting for logs...'; currentLogLength = 0;
            statusTitle.textContent = 'Processing Status';
            statusText.textContent = 'Uploading file...'; // <<< Set text part
            statusSpinner.classList.add('hidden'); // <<< Hide spinner
            form.reset(); submitButton.disabled = false; submitText.textContent = 'Start Processing'; submitSpinner.classList.add('hidden');
            audioBlob = null; audioPlayback.classList.add('hidden'); audioPlayback.src = '';
            fileInput.disabled = false; startRecordButton.disabled = false; stopRecordButton.disabled = true;
            recordingStatus.textContent = '';
        }

        function showError(message) {
             console.error("Showing error:", message);
             errorMessageBox.classList.remove('hidden'); errorMessageContent.textContent = message;
             tryAgainButton.classList.remove('hidden'); statusViewDiv.classList.remove('hidden');
             uploadFormDiv.classList.add('hidden'); resultArea.classList.add('hidden');
             statusSpinner.classList.add('hidden'); // <<< Hide spinner on error
        }

        processAnotherButton.addEventListener('click', resetUI);
        tryAgainButton.addEventListener('click', resetUI);

        // Enable/Disable recording based on file input logic (remains the same)
         fileInput.addEventListener('change', () => { /* ... */ });

    </script>
</body>
</html>

